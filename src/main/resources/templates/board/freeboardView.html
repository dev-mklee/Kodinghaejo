<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>게시판</title>
	<!-- Standard css -->
	<link rel="icon" href="/img/logo/favicon.png">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css">
	<!-- pub-js link -->
	<script src="/js/pub-ui-custom.js"></script>
</head>

<body>
	<!-- header 영역 -->
	<div id="header" th:replace="~{ /include/header }"></div>
	
	<!-- 글 내용 -->
	<div class="container" style="min-height: auto;">
		<div class="content-board-free-view">
			<div class="content-board-free-view-wrap">
				<h4>[[ ${ view.cat } ]]</h4>
				<h5>[[ ${ view.title } ]]</h5>
				<div class="profile-title">
					<img src="/img/test-profile/nonoping.png" alt="">
					<div class="profile-title-content">
						<p class="profile-name">[[ ${ view.writer } ]]</p>
						<p class="profile-date">[[ ${ view.regdate } ]]<!-- 5시간전 --></p>
					</div>
				</div>
				<div id="content"></div>
				<!--p>[[${view.content}]]</p-->
				<div class="profile-item">
					<ol>
						<li><i class="xi-eye-o"></i><span th:text="${ view.hitCnt }">{0}</span></li>
						<li><i class="xi-comment-o"></i><span id="replyCnt" th:text="${ view.replyCnt }">{0}</span></li>
					</ol>
					<ol>
						<li><i th:if="${view.goodChk == 'N'}" th:onclick="|toggleLike('${view.idx}', 'up')|" th:id="@{'like-up-' + ${view.idx}}" class="xi-heart-o"></i><i th:if="${view.goodChk == 'Y'}" th:onclick="|toggleLike('${view.idx}', 'down')|" th:id="@{'like-down-' + ${view.idx}}" class="xi-heart"></i><span id="like-count-${view.idx}" th:text="${view.goodCnt}">{0}</span></li>
						<li><i class="xi-cut" th:onclick="|reportPost('${view.Idx}')|" th:id="@{'report-button-' + ${view.idx}}"></i><span>신고하기</span></li>
						<th:block th:if="${session.email == view.email.email}">
						<li><a th:href="@{/board/m/freeboardmodify(idx=${view.idx})}">수정하기</a></li>
						<li><a th:href="|javascript:deactive('${view.idx}')|"> 삭제하기</a></li>
						</th:block>
					</ol>
				</div>
				<a href="javascript:history.back()" class="btn_menu" style="float: right; margin-top: 20px;">목록가기</a>
				<a href="javascript:replyLoad()" class="btn_menu" style="float: right; margin-top: 20px;">댓글보기</a>
			</div>
		</div>
	</div>

	<div class="container" style="background: #F9FAFB;">
		<!-- 댓글 쓰기 내역 -->
		<div th:if="${ session.email != null }" class="content-board-free-view-write">
			<form class="replyForm" id="replyForm" name="replyForm" method="post" >
				<h5>댓글 쓰기 영역</h5>
				<div id="replyWriteArea" style="width: 100%; height: 500px;"></div>
				<input type="hidden" id="rePrnt" name="rePrnt" value="FR">
				<input type="hidden" id="prntIdx" name="prntIdx" th:value="${ view.idx }">
				<input type="hidden" id="email" name="email" th:value="${ session.email }">
				<input type="hidden" id="writer" name="writer" th:value="${ session.nickname }">
			</form>
			<button class="view-write-btn" onclick="replyWrite()">댓글 등록</button>
		</div>
		<div th:if="${ session.email == null }" id="replyWriteArea" class="hidden"></div>
		<!-- 댓글 내용 -->
		<div class="content-board-free-view-review">
			<!-- 댓글 -->
			<div class="free-review-box">
				<h5>댓글</h5>
				<div id="replyList"></div>
			</div>
		</div>
	</div>
	<!-- footer영역 -->
	<div id="footer" th:replace="~{ /include/footer }"></div>
	
	<!-- toast API -->
	<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
	<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
	
	<!-- Custom Script -->
	<script type="text/javascript">
		//토스트 UI - 뷰어
		const viewer = new toastui.Editor.factory({
			el: document.querySelector('#content'),
			viewer: true,
			initialValue: '[[ ${ view.content } ]]'
		});
		
		//토스트 UI - 에디터
		const editor = new toastui.Editor({
			el: document.querySelector('#replyWriteArea'),	//에디터를 적용할 요소 (컨테이너)
			height: '400px',																//에디터 영역의 높이 값 (OOOpx || auto)
			initialEditType: 'markdown',										//최초로 보여줄 에디터 타입 (markdown || wysiwyg)
			placeholder: '내용을 입력해주세요.',						//내용의 초기 값으로, 반드시 마크다운 문자열 형태여야 함
			previewStyle: 'vertical',												//마크다운 프리뷰 스타일 (tab || vertical)
			toolbarItems: [
				//기본 툴바 항목에서 'image' 항목을 제외하고 나열합니다.
				[ 'heading', 'bold', 'italic', 'strike' ],
				[ 'hr', 'quote' ],
				[ 'ul', 'ol', 'task' ],
				[ 'table', 'link' ],
				//'image' 항목을 제거했습니다.
				[ 'code', 'codeblock' ]
			]
		});
		
		//========== 댓글 관련 처리 ==========
		var page = 1;
		var totalPage = 1;

		//최초 접근 시 댓글 목록 가져오기
		const replyLoad = async () => {
			let formData = new FormData();
			formData.append('page', page);
			formData.append('board_idx', '[[ ${ view.idx } ]]');
			
			await fetch('/board/replyView', {
				method: 'POST',
				body: formData
			})
			.then((response) => response.json())
			.then((data) => replyList(data))
			.catch((error) => {
				console.log('error: ' + error);
				Swal.fire({
					icon: 'error',
					text: '시스템 장애로 인해 댓글을 가져오는 데 실패했습니다.',
					confirmButtonText: '확인'
				});
			});
		}
		
		//댓글 목록 보기
		const replyList = (data) => {
			const sessionEmail = '[[ ${ session.email } ]]';
			
			const jsonInfo = data.content;
			
			totalPage = data.totalPages;
			replyCnt.innerText = data.totalElements;
			
			const replyList = document.querySelector('#replyList');
			
			for (const i in jsonInfo) {
				
				let profileImg = (jsonInfo[i].email.storedImg == null || jsonInfo[i].email.storedImg == '') ? '/img/test-profile/nonoping.png' : ('/member/img' + jsonInfo[i].email.email);
				
				const elm = document.createElement('div');
				elm.setAttribute('id', 'reply-' + jsonInfo[i].idx);
				elm.classList.add('free-review-list');
				
				let result = '';
				
				result += '<div class="free-review-list-title">\n' +
									'\t<div class="profile-title">\n' +
									'\t\t<div class="profile-title-content">\n' +
									'\t\t\t<img src="' + profileImg + '" alt="">\n' +
									'\t\t\t<p class="profile-name">' + jsonInfo[i].writer + '</p>\n' +
									'\t\t\t<p class="profile-date">' + jsonInfo[i].regdate + '</p>\n' +
									'\t\t</div>\n' +
									'\t</div>\n' +
									'</div>\n' +
									'<div class="free-review-list-content">\n' +
									'\t<p>' + jsonInfo[i].content + '</p>\n';

				if (sessionEmail == jsonInfo[i].email) {
					result += '\t<div class="user-free-board-tab">\n' +
										'\t\t<a class="btn_edit" href="javascript:editReply(' + jsonInfo[i].idx + ')">수정하기</a>\n' +
										'\t\t<a class="btn_delete" href="javascript:deleteReply(' + jsonInfo[i].idx + ')">삭제하기</a>\n' +
										'\t</div>\n';
				}
				
				result += '</div>';
				
				elm.innerHTML = result;
				replyList.appendChild(elm);
			}
		}
		
		//스크롤 맨 아래로 이동 시 다음 페이지 호출
		window.addEventListener('scroll', () => {
			var isScrollAtBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight;
			
			if (isScrollAtBottom) {
				if (page >= totalPage) return false;
				
				page++;
				replyLoad();
			}
		})
		
		//댓글 작성
		const replyWrite = async () => {
			let content = editor.getMarkdown();
			
			if (content.trim() == '') {
				Swal.fire({
					icon: 'warning',
					text: '내용을 입력해주세요.',
					confirmButtonText: '확인'
				});
				return false;
			}
				
			let formData = new FormData(replyForm);
			formData.append("content", content); //Toast UI Editor의 내용을 FormData에 추가
				
			await fetch('/board/m/replyWrite', {
				method: 'POST',
				body: formData
			})
			.then((response) => response.json())
			.then((data) => replyList(data))
			.catch((error) => {
				Swal.fire({
					icon: "error",
					text: "시스템 장애로 댓글등록에 실패했습니다!",
				});
				console.log("error" + error);
			})
		}
		
		//========== 댓글 관련 처리 종료 ==========

		/*
		const replyWrite = async () => {
			let content = editor.getMarkdown(); //마크다운 텍스트로 가져오기
	
			if (content.trim() == '') {
				Swal.fire({
					icon: "warning",
					text: "내용을 입력해주세요.",
					confirmButtonText: "확인"
				});
				return false;
			}
				
			let formData = new FormData(replyForm);
			formData.append("content", content); //Toast UI Editor의 내용을 FormData에 추가
				
			await fetch('/board/m/replyWrite', {
				method: 'POST',
				body: formData
			})
			.then((response) => response.json())
			.then((data) => replyList(data))
			.catch((error) => {
				Swal.fire({
					icon: "error",
					text: "시스템 장애로 댓글등록에 실패했습니다!",
				});
				console.log("error" + error);
			})
		}
		
		//댓글 비활성화 알람추가
		async function replyDeactive(replyIdx, prntIdx) {	
			try {
				const result = await 
				Swal.fire({
					title: "댓글을 삭제하시겠습니까?",
					icon: "warning",
					showCancelButton: true,
					confirmButtonText: "네, 삭제합니다",
					cancelButtonText: "취소"
				});
	
				if (result.isConfirmed) {
					const response = await fetch(`/board/m/replyDeactive?idx=${replyIdx}&prntIdx=${prntIdx}`, {
						method: 'GET'
					});
	
				if (response.ok) {
					 Swal.fire("댓글이 삭제되었습니다.", "", "success").then(() => {
							location.reload();
						});
		  } else {
					  Swal.fire("댓글 삭제에 실패했습니다.", "", "error");
					}
				}
		 } catch (error) {
					console.error("댓글 비활성화 중 오류 발생:", error);
					Swal.fire("댓글 비활성화 중 오류가 발생했습니다.", "", "error");
				}
		}

	function replyModify(replyIdx) {
		const contentP = document.getElementById('reply-text-' + replyIdx);
		const editTextarea = document.getElementById('reply-edit-' + replyIdx);
		const editButton = document.getElementById('edit-btn-'+ replyIdx);
		const saveButton = document.getElementById('save-btn-'+ replyIdx);

		// 기존 댓글 내용을 textarea에 복사하고 보여줌
		editTextarea.value = contentP.innerText;
		contentP.style.display = 'none';	// 기존 텍스트 숨기기
		editTextarea.style.display = 'block';	// textarea 표시
		editButton.style.display = 'none';	// "수정하기" 버튼 숨기기
		saveButton.style.display = 'inline';	// "저장하기" 버튼 표시
	}
		
	async function replySave(replyIdx){
		const editTextarea = document.getElementById('reply-edit-' + replyIdx);
		const updatedContent = editTextarea.value.trim();
			
		if (updatedContent.trim() === '') {
			Swal.fire({
				icon:"warning",
				text:"내용을 입력하세요"});
			return false;[]
		}
			
		try {
			const formData = new FormData();
			formData.append("idx", replyIdx);
			formData.append("content", updatedContent);

			const response = await fetch('/board/m/replyModify', {
				method: 'POST',
				body: formData
			});

		if (response.ok) {
			Swal.fire({
				icon: "success",
				title: "댓글이 수정되었습니다.",
				confirmButtonText: "확인" //확인 눌러야 로케이션 되는
				}).then((result) => {
			   if (result.isConfirmed) {
					location.reload(true);
					}
				});
		} else {
				Swal.fire({
					  icon: "error",
					  text: "수정에 실패했습니다!",
					});
				}
			} catch (error) {
			console.error("Error:", error);
			Swal.fire({
				  icon: "error",
				  text: "시스템 장애로 수정에 실패했습니다!",
				});
			} 
		}
		
		async function toggleLike(postIdx, action) {
			try {
				const response = await fetch('/board/m/toggleLike', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ postIdx, action })
				});
				const data = await response.json();

				document.getElementById(`like-count-${postIdx}`).innerText = data.likeCount;

				const likeUpBtn = document.getElementById(`like-up-${postIdx}`);
				const likeDownBtn = document.getElementById(`like-down-${postIdx}`);
	
				if (data.isLiked) {
					likeUpBtn.style.display = 'none';
					likeDownBtn.style.display = 'inline';
				} else {
					likeUpBtn.style.display = 'inline';
					likeDownBtn.style.display = 'none';
				}
			} catch (error) {
				console.error("좋아요 상태를 변경할 수 없습니다:", error);
			} finally {
				location.reload(true);
			}
		}
		
	//신고하기
	async function reportPost(postIdx) {
		const result = await Swal.fire({
			title: "게시글을 신고하시겠습니까?",
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: "네, 신고합니다",
			cancelButtonText: "취소"
		});
	  
		if (result.isConfirmed) {
			 try {
				 const response = await fetch('/board/m/report', {
					 method: 'POST',
					 headers: {
						   'Content-Type': 'application/json'
					   },
					   body: JSON.stringify({ postIdx })
				   });
					const data = await response.json();

					if (data.status === "success") {
						Swal.fire({
							icon: "success",
							text: data.message // 예: "게시물이 신고되었습니다."
						});
					} else if (data.status === "failure") {
						Swal.fire({
							icon: "info",
							text: data.message // 예: "이미 신고한 게시물입니다."
						});
					}
			} catch (error) {
				  console.error("신고 처리 중 오류 발생:", error);
				   Swal.fire({
					 	icon: "error",
						text: "시스템 장애로 신고에 실패했습니다!"
					});
				}
			}
		}
	
	
		//게시글비활성화
		async function deactive(viewidx) {
			try {
				const result = await Swal.fire({
					title: "게시글을 삭제하시겠습니까?",
					icon: "warning",
					showCancelButton: true,
					confirmButtonText: "네, 삭제합니다",
					cancelButtonText: "취소"
				});
		
				if (result.isConfirmed) {
					const response = await fetch(`/board/m/deactive?idx=${viewidx}`, {
						method: 'GET'
					});
		
					if (response.ok) {
						Swal.fire("게시글이 삭제되었습니다.", "", "success").then(() => {
							location.href = "/board/freeboard";
						});
					} else {
						Swal.fire("게시글 삭제에 실패했습니다.", "", "error");
					}
				}
			} catch (error) {
				console.error("게시글 비활성화 중 오류 발생:", error);
				Swal.fire("게시글 비활성화 중 오류가 발생했습니다.", "", "error");
			}
		}
		*/
	</script>
</body>
<script>
	replyLoad();
</script>
</html>